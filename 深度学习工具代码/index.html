
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.0.3">
    
    
      
        <title>深度学习工具代码 - 个人笔记</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.1655a90d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.7fa14f5b.min.css">
        
          
          
          <meta name="theme-color" content="#009485">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="teal" data-md-color-accent="pink">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#opencv" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="个人笔记" class="md-header__button md-logo" aria-label="个人笔记">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            个人笔记
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              深度学习工具代码
            
          </span>
        </div>
      </div>
    </div>
    <div class="md-header__options">
      
    </div>
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="个人笔记" class="md-nav__button md-logo" aria-label="个人笔记">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    个人笔记
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      <label class="md-nav__link" for="__nav_1">
        一、计算机视觉专栏
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="一、计算机视觉专栏" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          一、计算机视觉专栏
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%9B%AE%E6%A0%87%E6%A3%80%E6%B5%8B%E8%AE%BA%E6%96%87%E8%A7%A3%E8%AF%BB/" class="md-nav__link">
        目标检测论文解读
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../OCR%E6%96%B9%E5%90%91%E8%AE%BA%E6%96%87%E8%A7%A3%E8%AF%BB/" class="md-nav__link">
        OCR方向论文解读
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../%E4%BA%BA%E8%84%B8%E6%96%B9%E5%90%91%E8%AE%BA%E6%96%87%E8%A7%A3%E8%AF%BB/" class="md-nav__link">
        人脸方向论文解读
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%9B%BE%E5%83%8F%E8%AF%86%E5%88%AB%E8%AE%BA%E6%96%87%E8%A7%A3%E8%AF%BB/" class="md-nav__link">
        图像识别论文解读
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        深度学习基础
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      <label class="md-nav__link" for="__nav_2">
        二、AI代码专栏
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="二、AI代码专栏" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          二、AI代码专栏
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../PyTorch%E5%BF%AB%E9%80%9F%E6%95%99%E7%A8%8B/" class="md-nav__link">
        PyTorch快速教程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../PaddlePaddle%E5%BF%AB%E9%80%9F%E6%95%99%E7%A8%8B/" class="md-nav__link">
        PaddlePaddle快速教程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../caffe%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/" class="md-nav__link">
        Caffe快速教程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../onnx%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/" class="md-nav__link">
        ONNX简明教程
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          深度学习工具代码
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        深度学习工具代码
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#opencv" class="md-nav__link">
    opencv与图像处理基础
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    目标检测损失函数
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nms" class="md-nav__link">
    NMS及其变体
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    即插即用模块
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gpu" class="md-nav__link">
    自动检测GPU
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tsne" class="md-nav__link">
    TSNE可视化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-gradcam" class="md-nav__link">
    卷积可视化-GradCAM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    网络结构可视化工具
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#voc" class="md-nav__link">
    VOC数据集制作
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anchoryolov3" class="md-nav__link">
    数据集anchor计算(yolov3)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#map" class="md-nav__link">
    MAP计算库
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    人脸图片扩充
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    图像增亮
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../pandas%E3%80%81matplotlib%E7%AE%80%E6%B4%81%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        PD+PLT简洁笔记
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        三、常用工具专栏
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="三、常用工具专栏" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          三、常用工具专栏
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../%E9%87%8F%E5%8C%96%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/" class="md-nav__link">
        量化工具使用
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%AE%9E%E7%94%A8%E5%B7%A5%E5%85%B7%E6%95%99%E7%A8%8B/" class="md-nav__link">
        实用工具教程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../%E7%BD%91%E7%AB%99%E6%94%B6%E9%9B%86/" class="md-nav__link">
        学习网站收集
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%95%B0%E6%8D%AE%E5%A2%9E%E5%BC%BA%E5%BA%93%28albumentations%2BAugmentor%29/" class="md-nav__link">
        图像增强库
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      <label class="md-nav__link" for="__nav_4">
        四、编程语言专栏
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="四、编程语言专栏" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          四、编程语言专栏
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../c%2B%2B%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/" class="md-nav__link">
        c++简明教程
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../vim_cmake_git/" class="md-nav__link">
        vim_git_cmake
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../python%E5%88%B7%E9%A2%98/" class="md-nav__link">
        python刷题
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../java%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8Band%E5%AE%89%E5%8D%93%E5%BC%80%E5%8F%91/" class="md-nav__link">
        java简明教程and安卓开发
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#opencv" class="md-nav__link">
    opencv与图像处理基础
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    目标检测损失函数
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nms" class="md-nav__link">
    NMS及其变体
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    即插即用模块
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#gpu" class="md-nav__link">
    自动检测GPU
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tsne" class="md-nav__link">
    TSNE可视化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#-gradcam" class="md-nav__link">
    卷积可视化-GradCAM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    网络结构可视化工具
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#voc" class="md-nav__link">
    VOC数据集制作
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#anchoryolov3" class="md-nav__link">
    数据集anchor计算(yolov3)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#map" class="md-nav__link">
    MAP计算库
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    人脸图片扩充
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    图像增亮
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>深度学习工具代码</h1>
                
                <h3 id="opencv">opencv与图像处理基础<a class="headerlink" href="#opencv" title="Permanent link">&para;</a></h3>
<p><a href="https://www.yuque.com/darrenzhang/cv/hea2q5">code 链接</a></p>
<h3 id="_1">目标检测损失函数<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h3>
<ul>
<li>Smooth L1 Loss</li>
<li>IoU Loss</li>
<li>GIoU Loss</li>
<li>DIoU Loss</li>
<li>CIoU Loss</li>
</ul>
<p><strong>Smooth L1 Loss</strong></p>
<p><img alt="image-20200622172707852" src="../assets/image-20200622172707852.png" /></p>
<ul>
<li>缺点<ul>
<li>这里先求出四个点的loss，再相加，前提假设4个点是相互独立的，但实际四个点是相关联的</li>
<li>实际评价框检测的指标是使用<code>IOU</code>，用这种方式很可能多个检测框IOU差异很大，但<code>smooth l1 loss</code>相同。</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">smoothL1Loss</span><span class="p">(</span><span class="n">predict_box</span><span class="p">,</span><span class="n">gt_box</span><span class="p">,</span><span class="n">reduction</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    predict_box:[[x1,y1,x2,y2], [x1,y1,x2,y2],,,]</span>
<span class="sd">    gt_box:[[x1,y1,x2,y2], [x1,y1,x2,y2],,,]</span>
<span class="sd">    th: float</span>
<span class="sd">    reduction:&quot;mean&quot;or&quot;sum&quot;</span>
<span class="sd">    return: loss</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># 计算坐标差</span>
    <span class="n">x_diff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">predict_box</span> <span class="o">-</span> <span class="n">gt_box</span><span class="p">)</span> <span class="c1"># 其实就是计算两框各自两点对应的差值，四个值</span>
    <span class="c1"># torch.where(condition,x,y) -&gt; True:x,False:y</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">x_diff</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">,</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">x_diff</span> <span class="o">*</span> <span class="n">x_diff</span><span class="p">,</span><span class="n">x_diff</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reduction</span> <span class="o">!=</span> <span class="s2">&quot;mean&quot;</span> <span class="ow">or</span> <span class="n">reduction</span> <span class="o">!=</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;reduction must be mean or sum&quot;</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span> <span class="k">if</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">loss</span>

<span class="c1"># 常用官方实现</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="n">F</span><span class="o">.</span><span class="n">smooth_l1_loss</span><span class="p">(</span><span class="n">predict_box</span><span class="p">,</span> <span class="n">gt_box</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
</code></pre></div>
<p><strong>IOU Loss</strong></p>
<p><img alt="image-20200622174332051" src="../assets/image-20200622174332051.png" /></p>
<ul>
<li>
<p>缺点</p>
<ul>
<li>
<p>当预测框和目标框不相交时，<code>IoU(A,B)=0</code>时，不能反映A,B距离的远近 (很近的无交集框和很远的无交集框的输出一样) ，此时损失函数不可导，<code>IoU Loss</code>无法优化两个框不相交的情况。</p>
<ul>
<li><code>YOLO</code>中可能出现:按照<code>GT</code>是否在<code>cell</code>判断当前<code>bbox</code>是否需要回归</li>
<li><code>two stage</code>不一般不会出现，因为都会有一个<code>IOU&gt;=0.5</code>的筛选，不会对无交集的框进行回归。<ul>
<li>假设预测框和目标框的大小都确定，只要两个框的相交值是确定的，其IoU值是相同时，IoU值不能反映两个框是如何相交的。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img alt="image-20200618145028266" src="../assets/image-20200618145028266.png" /></p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># IOU Loss = -ln(IOU)</span>
<span class="k">def</span> <span class="nf">iouLoss</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">,</span> <span class="n">bboxes2</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span><span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    bboxes1:[[x1,y1,x2,y2], [x1,y1,x2,y2],,,] # predict_box</span>
<span class="sd">    bboxes2:[[x1,y1,x2,y2], [x1,y1,x2,y2],,,] # gt_box</span>
<span class="sd">    th: float</span>
<span class="sd">    reduction:&quot;mean&quot;or&quot;sum&quot;</span>
<span class="sd">    return: loss</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">bboxes1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">bboxes2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ious</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># 该类无gtbox或者无anchor box</span>
        <span class="k">return</span> <span class="n">ious</span>
    <span class="n">exchange</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">bboxes1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bboxes2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># 预测框过多</span>
        <span class="n">bboxes1</span><span class="p">,</span> <span class="n">bboxes2</span> <span class="o">=</span> <span class="n">bboxes2</span><span class="p">,</span> <span class="n">bboxes1</span>
        <span class="n">ious</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">))</span>
        <span class="n">exchange</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">area1</span> <span class="o">=</span> <span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="c1"># 预测框面积</span>
    <span class="n">area2</span> <span class="o">=</span> <span class="p">(</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="c1"># 真实框面积</span>

    <span class="n">inter_max_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:],</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span>
    <span class="n">inter_min_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">inter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">inter_max_xy</span> <span class="o">-</span> <span class="n">inter_min_xy</span><span class="p">),</span> <span class="nb">min</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span> <span class="c1"># eps保证分子不为0</span>
    <span class="n">inter_area</span> <span class="o">=</span> <span class="n">inter</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">inter</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">union</span> <span class="o">=</span> <span class="n">area1</span><span class="o">+</span><span class="n">area2</span><span class="o">-</span><span class="n">inter_area</span>
    <span class="n">ious</span> <span class="o">=</span> <span class="n">inter_area</span> <span class="o">/</span> <span class="n">union</span>
    <span class="n">ious</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">ious</span><span class="p">,</span><span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nb">max</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1"># 限定范围 0~1</span>
    <span class="k">if</span> <span class="n">exchange</span><span class="p">:</span>
        <span class="n">ious</span> <span class="o">=</span> <span class="n">ious</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="n">reduction</span> <span class="o">!=</span> <span class="s2">&quot;mean&quot;</span> <span class="ow">or</span> <span class="n">reduction</span> <span class="o">!=</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;reduction must be mean or sum&quot;</span><span class="p">)</span>
    <span class="c1"># loss = -ln(ious)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="n">ious</span><span class="o">.</span><span class="n">log</span><span class="p">())</span> <span class="k">if</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="n">ious</span><span class="o">.</span><span class="n">log</span><span class="p">())</span>
    <span class="c1"># loss = 1.0 - ious</span>
    <span class="c1"># loss = torch.mean(1.0 - ious) if reduction == &quot;mean&quot; else torch.sum(1.0 - ious)</span>
    <span class="k">return</span> <span class="n">loss</span>
</code></pre></div>
<p><strong>GIou Loss</strong></p>
<p><img alt="image-20200622180951407" src="../assets/image-20200622180951407.png" /></p>
<ul>
<li>
<p>缺点:当目标框完全包裹预测框的时候，<code>IoU</code>和<code>GIoU</code>的值都一样，此时<code>GIoU</code>退化为<code>IoU</code>, 无法区分其相对位置关系</p>
<p><img alt="image-20200618145801617" src="../assets/image-20200618145801617.png" /></p>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">giouLoss</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">,</span> <span class="n">bboxes2</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span><span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    bboxes1:[[x1,y1,x2,y2], [x1,y1,x2,y2],,,] # predict_box</span>
<span class="sd">    bboxes2:[[x1,y1,x2,y2], [x1,y1,x2,y2],,,] # gt_box</span>
<span class="sd">    th: float</span>
<span class="sd">    reduction:&quot;mean&quot;or&quot;sum&quot;</span>
<span class="sd">    return: loss</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">bboxes1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">bboxes2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ious</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ious</span>
    <span class="n">exchange</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">bboxes1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bboxes2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">bboxes1</span><span class="p">,</span> <span class="n">bboxes2</span> <span class="o">=</span> <span class="n">bboxes2</span><span class="p">,</span> <span class="n">bboxes1</span>
        <span class="n">ious</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">))</span>
        <span class="n">exchange</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">area1</span> <span class="o">=</span> <span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">area2</span> <span class="o">=</span> <span class="p">(</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span>
        <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">inter_max_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:],</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span>

    <span class="n">inter_min_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># out是最小外接矩形</span>
    <span class="n">out_max_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:],</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span>

    <span class="n">out_min_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">inter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">inter_max_xy</span> <span class="o">-</span> <span class="n">inter_min_xy</span><span class="p">),</span> <span class="nb">min</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">inter_area</span> <span class="o">=</span> <span class="n">inter</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">inter</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">outer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">out_max_xy</span> <span class="o">-</span> <span class="n">out_min_xy</span><span class="p">),</span> <span class="nb">min</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">outer_area</span> <span class="o">=</span> <span class="n">outer</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">outer</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">union</span> <span class="o">=</span> <span class="n">area1</span><span class="o">+</span><span class="n">area2</span><span class="o">-</span><span class="n">inter_area</span>
    <span class="n">closure</span> <span class="o">=</span> <span class="n">outer_area</span>

    <span class="n">gious</span> <span class="o">=</span> <span class="n">inter_area</span> <span class="o">/</span> <span class="n">union</span> <span class="o">-</span> <span class="p">(</span><span class="n">closure</span> <span class="o">-</span> <span class="n">union</span><span class="p">)</span> <span class="o">/</span> <span class="n">closure</span>
    <span class="n">gious</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">gious</span><span class="p">,</span><span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span><span class="nb">max</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exchange</span><span class="p">:</span>
        <span class="n">gious</span> <span class="o">=</span> <span class="n">gious</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="n">reduction</span> <span class="o">!=</span> <span class="s2">&quot;mean&quot;</span> <span class="ow">or</span> <span class="n">reduction</span> <span class="o">!=</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;reduction must be mean or sum&quot;</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">gious</span><span class="p">)</span> <span class="k">if</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">gious</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">loss</span>
</code></pre></div>
<p><strong>DIou Loss</strong></p>
<p><img alt="image-20200623173136836" src="../assets/image-20200623173136836.png" /></p>
<ul>
<li>优点<ul>
<li>当目标框不重叠时，仍然可以为边界框提供梯度</li>
<li><code>DIoU loss</code>可以直接最小化两个目标框的距离，收敛更快(<code>GIOU</code>优化两框的IOU,慢)</li>
<li>对于目标框包裹预测框的这种情况，<code>DIoU Loss</code>可以收敛的很快，而<code>GIoU Loss</code>此时退化为<code>IoU Loss</code>收敛速度较慢</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">diouLoss</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">,</span> <span class="n">bboxes2</span><span class="p">,</span><span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span><span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    bboxes1:[[x1,y1,x2,y2], [x1,y1,x2,y2],,,] # predict_box</span>
<span class="sd">    bboxes2:[[x1,y1,x2,y2], [x1,y1,x2,y2],,,] # gt_box</span>
<span class="sd">    th: float</span>
<span class="sd">    reduction:&quot;mean&quot;or&quot;sum&quot;</span>
<span class="sd">    return: loss</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">bboxes1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">bboxes2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">dious</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dious</span>
    <span class="n">exchange</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">bboxes1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bboxes2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">bboxes1</span><span class="p">,</span> <span class="n">bboxes2</span> <span class="o">=</span> <span class="n">bboxes2</span><span class="p">,</span> <span class="n">bboxes1</span>
        <span class="n">dious</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">))</span>
        <span class="n">exchange</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">w1</span> <span class="o">=</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">h2</span> <span class="o">=</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">area1</span> <span class="o">=</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">h1</span>
    <span class="n">area2</span> <span class="o">=</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">h2</span>
    <span class="n">center_x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">center_y1</span> <span class="o">=</span> <span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">center_x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">center_y2</span> <span class="o">=</span> <span class="p">(</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">inter_max_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:],</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span>
    <span class="n">inter_min_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">out_max_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:],</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span>
    <span class="n">out_min_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">inter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">inter_max_xy</span> <span class="o">-</span> <span class="n">inter_min_xy</span><span class="p">),</span> <span class="nb">min</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">inter_area</span> <span class="o">=</span> <span class="n">inter</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">inter</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">inter_diag</span> <span class="o">=</span> <span class="p">(</span><span class="n">center_x2</span> <span class="o">-</span> <span class="n">center_x1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">center_y2</span> <span class="o">-</span> <span class="n">center_y1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">outer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">out_max_xy</span> <span class="o">-</span> <span class="n">out_min_xy</span><span class="p">),</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">outer_diag</span> <span class="o">=</span> <span class="p">(</span><span class="n">outer</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">outer</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">union</span> <span class="o">=</span> <span class="n">area1</span><span class="o">+</span><span class="n">area2</span><span class="o">-</span><span class="n">inter_area</span>
    <span class="n">dious</span> <span class="o">=</span> <span class="n">inter_area</span> <span class="o">/</span> <span class="n">union</span> <span class="o">-</span> <span class="p">(</span><span class="n">inter_diag</span><span class="p">)</span> <span class="o">/</span> <span class="n">outer_diag</span>
    <span class="n">dious</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">dious</span><span class="p">,</span><span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span><span class="nb">max</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exchange</span><span class="p">:</span>
        <span class="n">dious</span> <span class="o">=</span> <span class="n">dious</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="n">reduction</span> <span class="o">!=</span> <span class="s2">&quot;mean&quot;</span> <span class="ow">or</span> <span class="n">reduction</span> <span class="o">!=</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;reduction must be mean or sum&quot;</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">dious</span><span class="p">)</span> <span class="k">if</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">dious</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">loss</span>
</code></pre></div>
<p><strong>Ciou Loss</strong></p>
<p><img alt="image-20200623173410371" src="../assets/image-20200623173410371.png" /></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">bbox_overlaps_ciou</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">,</span> <span class="n">bboxes2</span><span class="p">):</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">bboxes1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">bboxes2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cious</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">rows</span> <span class="o">*</span> <span class="n">cols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cious</span>
    <span class="n">exchange</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">bboxes1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bboxes2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">bboxes1</span><span class="p">,</span> <span class="n">bboxes2</span> <span class="o">=</span> <span class="n">bboxes2</span><span class="p">,</span> <span class="n">bboxes1</span>
        <span class="n">cious</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">))</span>
        <span class="n">exchange</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">w1</span> <span class="o">=</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">h1</span> <span class="o">=</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">h2</span> <span class="o">=</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

    <span class="n">area1</span> <span class="o">=</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">h1</span>
    <span class="n">area2</span> <span class="o">=</span> <span class="n">w2</span> <span class="o">*</span> <span class="n">h2</span>

    <span class="n">center_x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">center_y1</span> <span class="o">=</span> <span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">center_x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">center_y2</span> <span class="o">=</span> <span class="p">(</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">inter_max_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:],</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span>
    <span class="n">inter_min_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">out_max_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:],</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">:])</span>
    <span class="n">out_min_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">bboxes1</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span><span class="n">bboxes2</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">inter</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">inter_max_xy</span> <span class="o">-</span> <span class="n">inter_min_xy</span><span class="p">),</span> <span class="nb">min</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
    <span class="n">inter_area</span> <span class="o">=</span> <span class="n">inter</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">inter</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">inter_diag</span> <span class="o">=</span> <span class="p">(</span><span class="n">center_x2</span> <span class="o">-</span> <span class="n">center_x1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">center_y2</span> <span class="o">-</span> <span class="n">center_y1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">outer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">((</span><span class="n">out_max_xy</span> <span class="o">-</span> <span class="n">out_min_xy</span><span class="p">),</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">outer_diag</span> <span class="o">=</span> <span class="p">(</span><span class="n">outer</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">outer</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">union</span> <span class="o">=</span> <span class="n">area1</span><span class="o">+</span><span class="n">area2</span><span class="o">-</span><span class="n">inter_area</span>
    <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">inter_diag</span><span class="p">)</span> <span class="o">/</span> <span class="n">outer_diag</span>
    <span class="n">iou</span> <span class="o">=</span> <span class="n">inter_area</span> <span class="o">/</span> <span class="n">union</span>
    <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">/</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">pow</span><span class="p">((</span><span class="n">torch</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">w2</span> <span class="o">/</span> <span class="n">h2</span><span class="p">)</span> <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">atan</span><span class="p">(</span><span class="n">w1</span> <span class="o">/</span> <span class="n">h1</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">S</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">iou</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="p">(</span><span class="n">S</span> <span class="o">+</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">cious</span> <span class="o">=</span> <span class="n">iou</span> <span class="o">-</span> <span class="p">(</span><span class="n">u</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span>
    <span class="n">cious</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">cious</span><span class="p">,</span><span class="nb">min</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">,</span><span class="nb">max</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exchange</span><span class="p">:</span>
        <span class="n">cious</span> <span class="o">=</span> <span class="n">cious</span><span class="o">.</span><span class="n">T</span>

    <span class="k">if</span> <span class="n">reduction</span> <span class="o">!=</span> <span class="s2">&quot;mean&quot;</span> <span class="ow">or</span> <span class="n">reduction</span> <span class="o">!=</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;reduction must be mean or sum&quot;</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">cious</span><span class="p">)</span> <span class="k">if</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">cious</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">loss</span>
</code></pre></div>
<h3 id="nms">NMS及其变体<a class="headerlink" href="#nms" title="Permanent link">&para;</a></h3>
<ul>
<li>nms</li>
<li>DIoU-NMS</li>
</ul>
<p><strong>nms</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">nms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply non-maximum suppression at test time to avoid detecting too many</span>
<span class="sd">    overlapping bounding boxes for a given object.</span>
<span class="sd">    Args:</span>
<span class="sd">        boxes: (tensor) The location preds for the img, Shape: [num_priors,4].</span>
<span class="sd">        scores: (tensor) The class predscores for the img, Shape:[num_priors].</span>
<span class="sd">        overlap: (float) The overlap thresh for suppressing unnecessary boxes.</span>
<span class="sd">        top_k: (int) The Maximum number of box preds to consider.</span>
<span class="sd">    Return:</span>
<span class="sd">        The indices of the kept boxes with respect to num_priors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">keep</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span><span class="o">.</span><span class="n">long</span><span class="p">()</span> <span class="c1"># 用来存储保留下的框index</span>
    <span class="k">if</span> <span class="n">boxes</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">keep</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span> <span class="c1"># 对应位置相乘</span>
    <span class="n">v</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># 上升排序，返回values,indexs</span>
    <span class="c1"># I = I[v &gt;= 0.01]</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="n">top_k</span><span class="p">:]</span>  <span class="c1"># 上升排序索引，取topk个，这k个框用来遍历求解</span>
    <span class="n">xx1</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">new</span><span class="p">()</span> <span class="c1"># 复制boxes的一切属性，但value=[]</span>
    <span class="n">yy1</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
    <span class="n">xx2</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
    <span class="n">yy2</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

    <span class="c1"># keep = torch.Tensor()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">idx</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># torch.numel() 返回tensor变量内所有元素个数</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 取最大值的索引</span>
        <span class="c1"># keep.append(i)</span>
        <span class="n">keep</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="c1"># 保留score最大的框索引</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># 遍历的时候排除最大score的框</span>
        <span class="c1"># torch.index_select(input,dim,index,out=None) # 沿着指定维度对输入进行切片，取index中的指定的相应项，然后返回一个新的张量(不共享内存空间)</span>
        <span class="c1"># input(tensor)-&gt;输入张量;dim(int:0/1)-&gt;索引的轴;index(LongTensor)-&gt;包含索引下标的一维张量;out(Tensor)-&gt;目标张量</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">xx1</span><span class="p">)</span> <span class="c1"># 根据idx索引，去除x1的值，放到xx1里面</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">yy1</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">xx2</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">yy2</span><span class="p">)</span>
        <span class="c1"># store element-wise max with next highest score</span>
        <span class="n">xx1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">xx1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">x1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">yy1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">yy1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">y1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">xx2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">xx2</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">yy2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">yy2</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">y2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">w</span><span class="o">.</span><span class="n">resize_as_</span><span class="p">(</span><span class="n">xx2</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">resize_as_</span><span class="p">(</span><span class="n">yy2</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">xx2</span> <span class="o">-</span> <span class="n">xx1</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">yy2</span> <span class="o">-</span> <span class="n">yy1</span>
        <span class="c1"># check sizes of xx1 and xx2.. after each iteration</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">inter</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">h</span>
        <span class="c1"># IoU = i / (area(a) + area(b) - i)</span>
        <span class="n">rem_areas</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>  <span class="c1"># load remaining areas)</span>
        <span class="n">union</span> <span class="o">=</span> <span class="p">(</span><span class="n">rem_areas</span> <span class="o">-</span> <span class="n">inter</span><span class="p">)</span> <span class="o">+</span> <span class="n">area</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">IoU</span> <span class="o">=</span> <span class="n">inter</span><span class="o">/</span><span class="n">union</span>  <span class="c1"># store result in iou</span>
        <span class="c1"># keep only elements with an IoU &lt;= overlap</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">IoU</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">overlap</span><span class="p">)]</span> <span class="c1"># IoU.le(val) 返回的是True/False组成的向量</span>
    <span class="k">return</span> <span class="n">keep</span><span class="p">,</span> <span class="n">count</span>

<span class="c1"># 使用</span>
<span class="n">ids</span><span class="p">,</span><span class="n">count</span> <span class="o">=</span> <span class="n">nms</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">scores</span><span class="p">[</span><span class="n">ids</span><span class="p">[:</span><span class="n">count</span><span class="p">]]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">bboxes</span><span class="p">[</span><span class="n">ids</span><span class="p">[:</span><span class="n">count</span><span class="p">]]),</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>
<p><strong>DIoU-NMS</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">diounms</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">scores</span><span class="p">,</span> <span class="n">overlap</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">beta1</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply DIoU-NMS at test time to avoid detecting too many</span>
<span class="sd">    overlapping bounding boxes for a given object.</span>
<span class="sd">    Args:</span>
<span class="sd">        boxes: (tensor) The location preds for the img, Shape: [num_priors,4].</span>
<span class="sd">        scores: (tensor) The class predscores for the img, Shape:[num_priors].</span>
<span class="sd">        overlap: (float) The overlap thresh for suppressing unnecessary boxes.</span>
<span class="sd">        top_k: (int) The Maximum number of box preds to consider.</span>
<span class="sd">        beta1: (float) DIoU=IoU-R_DIoU^{beta1}.</span>
<span class="sd">    Return:</span>
<span class="sd">        The indices of the kept boxes with respect to num_priors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">keep</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">scores</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">zero_</span><span class="p">()</span><span class="o">.</span><span class="n">long</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">boxes</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">keep</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">area</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span>
    <span class="n">v</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># sort in ascending order</span>
    <span class="c1"># I = I[v &gt;= 0.01]</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="n">top_k</span><span class="p">:]</span>  <span class="c1"># indices of the top-k largest vals</span>
    <span class="n">xx1</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
    <span class="n">yy1</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
    <span class="n">xx2</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
    <span class="n">yy2</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

    <span class="c1"># keep = torch.Tensor()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">idx</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># index of current largest val</span>
        <span class="c1"># keep.append(i)</span>
        <span class="n">keep</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># remove kept element from view</span>
        <span class="c1"># load bboxes of next highest vals</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">xx1</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">yy1</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">xx2</span><span class="p">)</span>
        <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">yy2</span><span class="p">)</span>
        <span class="c1"># store element-wise max with next highest score</span>
        <span class="n">inx1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">xx1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">x1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">iny1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">yy1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">y1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">inx2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">xx2</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">iny2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">yy2</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">y2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">center_x1</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">center_y1</span> <span class="o">=</span> <span class="p">(</span><span class="n">y1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">y2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">center_x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">xx1</span> <span class="o">+</span> <span class="n">xx2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">center_y2</span> <span class="o">=</span> <span class="p">(</span><span class="n">yy1</span> <span class="o">+</span> <span class="n">yy2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">center_x1</span> <span class="o">-</span> <span class="n">center_x2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">center_y1</span> <span class="o">-</span> <span class="n">center_y2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">cx1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">xx1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">x1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">cy1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">yy1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">y1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">cx2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">xx2</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">x2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">cy2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">yy2</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">y2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx2</span> <span class="o">-</span> <span class="n">cx1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">cy2</span> <span class="o">-</span> <span class="n">cy1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">u</span><span class="o">=</span> <span class="n">d</span> <span class="o">/</span> <span class="n">c</span>
        <span class="n">w</span><span class="o">.</span><span class="n">resize_as_</span><span class="p">(</span><span class="n">xx2</span><span class="p">)</span>
        <span class="n">h</span><span class="o">.</span><span class="n">resize_as_</span><span class="p">(</span><span class="n">yy2</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">inx2</span> <span class="o">-</span> <span class="n">inx1</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">iny2</span> <span class="o">-</span> <span class="n">iny1</span>
        <span class="c1"># check sizes of xx1 and xx2.. after each iteration</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">inter</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">h</span>
        <span class="c1"># IoU = i / (area(a) + area(b) - i)</span>
        <span class="n">rem_areas</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="n">area</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>  <span class="c1"># load remaining areas)</span>
        <span class="n">union</span> <span class="o">=</span> <span class="p">(</span><span class="n">rem_areas</span> <span class="o">-</span> <span class="n">inter</span><span class="p">)</span> <span class="o">+</span> <span class="n">area</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">IoU</span> <span class="o">=</span> <span class="n">inter</span><span class="o">/</span><span class="n">union</span> <span class="o">-</span> <span class="n">u</span> <span class="o">**</span> <span class="n">beta1</span> <span class="c1"># store result in diou</span>
        <span class="c1"># keep only elements with an IoU &lt;= overlap</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">IoU</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="n">overlap</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">keep</span><span class="p">,</span> <span class="n">count</span>
</code></pre></div>
<h3 id="_2">即插即用模块<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/pprp/SimpleCVReproduction">代码持续更新</a></p>
<p>即插即用模块一般是作为一个独立的模块，可以用于取代普通的卷积结构，或者直接插入网络结构中，用的好有奇效，就看你会用不会用，具体插入什么位置最好看一下论文，一般而言常插入四个位置。</p>
<ol>
<li>
<p>瓶颈层：比如 ResNet，DenseNet 的瓶颈层。</p>
</li>
<li>
<p>上采样层：比如 FPN 分支，Attention UNet。</p>
</li>
<li>
<p>骨干网络最后一层：比如 SPP, ASPP 等</p>
</li>
<li>
<p>所有的 3x3 卷积：比如深度可分离卷积等</p>
</li>
<li>
<p>注意力模块<a href="https://github.com/pprp/SimpleCVReproduction/tree/master/Plug-and-play module/attention">code</a></p>
<ul>
<li>
<p>AFF(注意力**特征融合**:性能优于SKNet、SENet)</p>
</li>
<li>
<p>SENet</p>
</li>
<li>SKNet(SENet的改进)</li>
<li>scSE(SENet的改进,分割网络常用)</li>
<li>Non-Local Net(计算量过大,通用,视频分类效果更好)</li>
<li>GCNet(解决Non-Local Net计算量过大问题:Non-Local Net+SENet优点)</li>
<li>CCNet(Non-Local Net发展得到，语义分割常用)</li>
<li>CBAM(Faster-Rcnn两个点提升,通道空间串联)</li>
<li>BAM(CBAM同作者,通道空间并联)</li>
<li>SplitAttention(ResNeSt = SENet + SKNet + ResNeXt，<a href="https://hangzhang.org/files/resnest.pdf">论文</a>)</li>
</ul>
</li>
</ol>
<p><strong>MS-CAM&rarr;(AFF模块/iAFF模块)</strong>|<a href="https://github.com/YimianDai/open-aff">code</a>|<a href="https://arxiv.org/abs/2009.14082">论文</a>|<a href="https://mp.weixin.qq.com/s/xttOO1FG0X-3nu-rCQUhhw">博客</a></p>
<p>一般的特征融合(来自不同层或分支的特征的组合)通常都是通过简单的求和或串联实现，但这并不是最佳选择，本篇剔除注意力特征融合，适用于大多数场景，比如resnet/inception等层的特征融合。尺度不同如何融合：提出也了一个多尺度的通道注意力模块，该模块解决了在融合不同尺度的特征时出现的问题。同时还通过添加另一个注意力级别（称为迭代注意力特征融合）来缓解特征图的初始集成的瓶颈。</p>
<ul>
<li><strong>Multi-Scale Channel Attention Module(MS-CAM)</strong>:核心思想是通过改变空间池的大小，可以在多个尺度上实现通道关注;选择逐点卷积(PWConv)作为通道上下文融合器，它只利用每个空间位置的点向通道融合。</li>
</ul>
<p><img alt="image-20201009155037234" src="../assets/image-20201009155037234.png" /></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">ResGlobLocaChaFuse</span><span class="p">(</span><span class="n">HybridBlock</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResGlobLocaChaFuse</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_scope</span><span class="p">():</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">local_att</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">HybridSequential</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;local_att&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_att</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_att</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">global_att</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">HybridSequential</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;global_att&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_att</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">GlobalAvgPool2D</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_att</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_att</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hybrid_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">residual</span><span class="p">):</span>

        <span class="n">xa</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">residual</span>
        <span class="n">xl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_att</span><span class="p">(</span><span class="n">xa</span><span class="p">)</span>
        <span class="n">xg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_att</span><span class="p">(</span><span class="n">xa</span><span class="p">)</span>
        <span class="n">xlg</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">broadcast_add</span><span class="p">(</span><span class="n">xl</span><span class="p">,</span> <span class="n">xg</span><span class="p">)</span>
        <span class="n">wei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">(</span><span class="n">xlg</span><span class="p">)</span>

        <span class="n">xo</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">F</span><span class="o">.</span><span class="n">broadcast_mul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">wei</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">F</span><span class="o">.</span><span class="n">broadcast_mul</span><span class="p">(</span><span class="n">residual</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">wei</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xo</span>
</code></pre></div>
<ul>
<li><strong>AFF模块</strong>:基于多尺度信道的注意模块M，Attentional Feature Fusion (AFF) 可以被表达为</li>
</ul>
<p><img alt="image-20201009155216776" src="../assets/image-20201009155216776.png" /></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AXYforXplusYAddFuse</span><span class="p">(</span><span class="n">HybridBlock</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AXYforXplusYAddFuse</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_scope</span><span class="p">():</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">local_att</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">HybridSequential</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;local_att&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_att</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_att</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">global_att</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">HybridSequential</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;global_att&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_att</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">GlobalAvgPool2D</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_att</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_att</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hybrid_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">residual</span><span class="p">):</span>

        <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">residual</span>
        <span class="n">xl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_att</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
        <span class="n">xg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_att</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
        <span class="n">xlg</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">broadcast_add</span><span class="p">(</span><span class="n">xl</span><span class="p">,</span> <span class="n">xg</span><span class="p">)</span>
        <span class="n">wei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">(</span><span class="n">xlg</span><span class="p">)</span>

        <span class="n">xo</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">broadcast_mul</span><span class="p">(</span><span class="n">wei</span><span class="p">,</span> <span class="n">residual</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span>

        <span class="k">return</span> <span class="n">xo</span>
</code></pre></div>
<ul>
<li><strong>iAFF模块</strong>:完全上下文感知方法有一个不可避免的问题，即如何初始地集成输入特性。初始融合质量作为注意力模块的输入会对最终融合权重产生影响。由于这仍然是一个特征融合问题，一种直观的方法是使用另一个attention模块来融合输入的特征，即iterative Attentional Feature Fusion (iAFF)：</li>
</ul>
<p><img alt="image-20201009155342392" src="../assets/image-20201009155342392.png" /></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">AXYforXYAddFuse</span><span class="p">(</span><span class="n">HybridBlock</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AXYforXYAddFuse</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_scope</span><span class="p">():</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">local_att</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">HybridSequential</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;local_att&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_att</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_att</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">global_att</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">HybridSequential</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;global_att&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_att</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">GlobalAvgPool2D</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_att</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">global_att</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm</span><span class="p">())</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Activation</span><span class="p">(</span><span class="s1">&#39;sigmoid&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hybrid_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">residual</span><span class="p">):</span>

        <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">residual</span>
        <span class="n">xl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_att</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
        <span class="n">xg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_att</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
        <span class="n">xlg</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">broadcast_add</span><span class="p">(</span><span class="n">xl</span><span class="p">,</span> <span class="n">xg</span><span class="p">)</span>
        <span class="n">wei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">(</span><span class="n">xlg</span><span class="p">)</span>

        <span class="n">xo</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">broadcast_mul</span><span class="p">(</span><span class="n">wei</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">xo</span>
</code></pre></div>
<p><strong>SENet</strong>|<a href="https://arxiv.org/pdf/1709.01507">论文</a></p>
<p>将全局空间信息压缩到通道描述中，以捕获与通道的依赖关系。</p>
<p><img alt="image-20200624161403449" src="../assets/image-20200624161403449.png" /></p>
<ul>
<li>
<p><code>Ftr</code>:传统的卷积网络,<code>X</code>与<code>U</code>是输入和输出，<code>U</code>之后是新增的</p>
</li>
<li>
<p>上半部分</p>
<ul>
<li>
<p><code>F_sq(.)</code>:先对<code>U</code>做个<code>Global Average Pooling</code>，即<code>Squeeze</code>过程，输出<code>1x1xC</code></p>
<ul>
<li><code>1x1</code>:因为最终的<code>scale</code>是对整个通道作用的，作者利用的是通道间的相关性而非空间分布相关性，所以将空间上所有点的信息都平均成了一个值。</li>
</ul>
</li>
<li>
<p><code>F_ex(.)</code>:再经过两级全连接,属于<code>Excitation</code></p>
<ul>
<li>
<p>为什么用全连接层:为了利用通道间的相关性来训练出真正的scale。</p>
<ul>
<li>如果无全连接层，那么上面分支根本无反向计算、无训练的过程，就无法基于全部数据集来训练得出通道增强、减弱的规律。</li>
<li>有人会说卷积训练出的权值就含有了scale的成分在里面，也利用了通道间的相关性，为啥还要多个<code>SE Block</code>？<ul>
<li>因为这种卷积有空间的成分在里面，为了排除空间上的干扰就得先用GAP压缩成一个点后再作卷积，压缩后因为没有了<code>Height</code>、<code>Width</code>的成分，这种卷积就是全连接了。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>第一个全连接把<code>C</code>个通道压缩成了<code>C/r</code>个通道来降低计算量（后面跟了<code>RELU</code>）</p>
<ul>
<li><code>r</code>是指压缩的比例。作者尝试了<code>r</code>在各种取值下的性能 ，最后得出结论<code>r=16</code>时整体性能和计算量最平衡。</li>
</ul>
</li>
<li>第二个全连接再恢复回<code>C</code>个通道（后面跟了<code>Sigmoid</code>）</li>
</ul>
</li>
<li>
<p>最后用<code>sigmoid</code>限制到<code>[0,1]</code>范围</p>
</li>
</ul>
</li>
<li>
<p>下半部分</p>
<ul>
<li><code>F_scale(.)</code>:上半部分输出作为<code>scale</code>乘到<code>U的C个通道</code>上， 作为下一级的输入数据</li>
</ul>
</li>
<li>
<p>总结</p>
<ul>
<li>
<p><strong>原理</strong>:通过控制<code>scale</code>的大小，<code>SENet</code>把重要通道的特征强化，非重要通道的特征弱化，从而让提取的特征指向性更强。</p>
</li>
<li>
<p>应用</p>
<p><img alt="image-20200624170753297" src="../assets/image-20200624170753297.png" /></p>
</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>

<span class="k">class</span> <span class="nc">SELayer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">channel</span><span class="p">,</span><span class="n">reduction</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SELayer</span><span class="p">,</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avgpool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#自适应平均池化,通道数不改变，只给outsize=xx即可-&gt;(b,n,1,1)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="n">channel</span><span class="o">//</span><span class="n">reduction</span><span class="p">,</span><span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">channel</span><span class="o">//</span><span class="n">reduction</span><span class="p">,</span><span class="n">channel</span><span class="p">,</span><span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avgpool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="c1"># shape-&gt;(b,c)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</code></pre></div>
<p><strong>SkNet(SENet的改进)</strong>|<a href="https://arxiv.org/pdf/1903.06586">论文</a></p>
<ul>
<li>好多网络使用了各种<code>Trick</code>降低计算量，如<code>ResNeXt</code>，计算量的减少，精度却略有提升。那么如果不牺牲太多计算量精度是否能再提高一点？比如使用大的<code>KerNel=5x5</code></li>
<li>结合现有普遍使用的<code>Attention</code>操作</li>
<li>加了上面两个操作之后，显然计算量会上去，于是作者再加了一个<code>Group Convlution</code>来做<code>trade off</code></li>
</ul>
<p><img alt="image-20200624171435971" src="../assets/image-20200624171435971.png" /></p>
<ul>
<li><code>Split</code>:输入<code>c*h*w</code>的特征图，<code>F^,F~</code>均表示<code>Group Convlution</code>(分组卷积:减少计算量)，两者卷积核大小不同目的在于提升精度。</li>
<li><code>Fuse</code>:通过<code>Split</code>操作分成两路,各路进行一个<code>Sequeeze and Excitation block</code>操作。</li>
<li><code>Select</code>：把<code>Sequeeze and Excitation block</code>模块的结果通过两个<code>softmax</code>以回归出<code>Channel</code>之间的权重信息。然后把这个权重信息乘到<code>U^,U~</code>中，这个过程可以看做是一个<code>`soft attention</code>。最后把两路的特征图进行相加得到输出特征图<code>V</code></li>
<li><code>Select</code>部分的<code>attention</code>不仅考虑了<code>Channel</code>之间的权重，还考虑了两路卷积的权重.</li>
</ul>
<p><img alt="image-20200624173234144" src="../assets/image-20200624173234144.png" /></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch</span>

<span class="k">class</span> <span class="nc">SKConv</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">WH</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">L</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Constructor</span>
<span class="sd">        Args:</span>
<span class="sd">            features: input channel dimensionality.</span>
<span class="sd">            WH: input spatial dimensionality, used for GAP kernel size.</span>
<span class="sd">            M: the number of branchs.</span>
<span class="sd">            G: num of convolution groups.</span>
<span class="sd">            r: the radio for compute d, the length of z.</span>
<span class="sd">            stride: stride, default 1.</span>
<span class="sd">            L: the minimum dim of the vector z in paper, default 32.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SKConv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">features</span> <span class="o">/</span> <span class="n">r</span><span class="p">),</span> <span class="n">L</span><span class="p">)</span><span class="c1"># 获取Fuse的z模块fc的压缩通道，其实就是上图的z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="n">M</span> <span class="c1"># 分支数量</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span> <span class="c1"># 输入通道</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span><span class="c1"># 遍历M个分支依次加入到self.convs中，只不过每个分支的kernel和padding不同</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">features</span><span class="p">,</span>
                              <span class="n">features</span><span class="p">,</span>
                              <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
                              <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span>
                              <span class="n">padding</span><span class="o">=</span><span class="mi">1</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                              <span class="n">groups</span><span class="o">=</span><span class="n">G</span><span class="p">),</span> <span class="c1"># 分组卷积,channel/groups,groups=feature为深度可分离卷</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">features</span><span class="p">),</span>
                    <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>
        <span class="c1"># self.gap = nn.AvgPool2d(int(WH/stride))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fcs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([])</span> <span class="c1"># M个分支的fc列表</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">features</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">conv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convs</span><span class="p">):</span> <span class="c1"># 3分支时是图中的u1,u2,u3</span>
            <span class="n">fea</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze_</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># torch.Size([b, 1, c, h, w]),扩展dim=1这个通道是为了3分支的concat</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">feas</span> <span class="o">=</span> <span class="n">fea</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feas</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">feas</span><span class="p">,</span> <span class="n">fea</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fea_U</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">feas</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># fea_U.shape-&gt;[b,c,h,w],dim=1因为相加后消失</span>
        <span class="c1"># fea_U:是上图中第一个+</span>
        <span class="c1"># fea_s = self.gap(fea_U).squeeze_()</span>
        <span class="n">fea_s</span> <span class="o">=</span> <span class="n">fea_U</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 沿着H*W面进行平均，类似adaptivaAvgPool2d fea_s.shape:[b,c]。h,w因为mean后消失</span>
        <span class="n">fea_z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc</span><span class="p">(</span><span class="n">fea_s</span><span class="p">)</span> <span class="c1"># 通道压缩:[b,c]-&gt;[b,z]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fcs</span><span class="p">):</span> <span class="c1"># 放大通道:z-&gt;c，并且M个分支处理</span>
            <span class="n">vector</span> <span class="o">=</span> <span class="n">fc</span><span class="p">(</span><span class="n">fea_z</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze_</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># [b,1,z]</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">attention_vectors</span> <span class="o">=</span> <span class="n">vector</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">attention_vectors</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">attention_vectors</span><span class="p">,</span> <span class="n">vector</span><span class="p">],</span>
                                              <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># attention_vectors.shape-&gt;[b,M,c]</span>
        <span class="n">attention_vectors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">attention_vectors</span><span class="p">)</span>
        <span class="n">attention_vectors</span> <span class="o">=</span> <span class="n">attention_vectors</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># [b,M,c,1,1]</span>
        <span class="n">fea_v</span> <span class="o">=</span> <span class="p">(</span><span class="n">feas</span> <span class="o">*</span> <span class="n">attention_vectors</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 上图三条跳跃线,M个分支通道各自相乘并求和</span>
        <span class="k">return</span> <span class="n">fea_v</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span><span class="mi">24</span><span class="p">))</span>
    <span class="n">sk</span> <span class="o">=</span> <span class="n">SKConv</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span><span class="n">WH</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">M</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">G</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">sk</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># torch.Size([32, 256, 24, 24])，输入和输出大小一样</span>
</code></pre></div>
<p><strong>SCSE</strong>|<a href="http://arxiv.org/pdf/1803.02579v2">论文</a></p>
<p><code>scSE</code> 分为两个模块:一个是<code>sSE</code>和 <code>cSE</code> 模块，分别是空间注意力和通道注意力，最终以相加的方式融合。论文中只将其使用在**分割模型**(对语义分割准确率提升较大而且使分割边界更平滑)中，在很多图像分割比赛中都有用到这个模块作为 trick(比如<code>UNet</code>,可以放在每个卷积层后面)。</p>
<p><img alt="image-20200625210249825" src="../assets/image-20200625210249825.png" /></p>
<ul>
<li><strong>cSE(通道注意力)</strong><ul>
<li>将<code>feature map</code>通过<code>global average pooling</code>方法从<code>[C, H, W]</code>变为<code>[C, 1, 1]</code></li>
<li>然后使用两个<code>1×1</code>卷积进行信息的处理，最终得到C维的向量</li>
<li>然后使用<code>sigmoid</code>函数进行归一化，得到对应的mask</li>
<li>最后通过<code>channel-wise</code>相乘，得到经过信息校准过的<code>feature map</code></li>
</ul>
</li>
<li><strong>sSE(空间注意力)</strong><ul>
<li>直接对<code>feature map</code>使用<code>1×1</code>卷积, 从<code>[C, H, W]</code>变为<code>[1, H, W]</code>的features</li>
<li>然后使用<code>sigmoid</code>进行激活得到<code>spatial attention map</code></li>
<li>然后直接施加到原始feature map中，完成空间的信息校准</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 输入维度和输出维度一样</span>
<span class="k">class</span> <span class="nc">cSE</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avgpool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># gap-&gt;[b,c,1,1]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Conv_Squeeze</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span>
                                      <span class="n">in_channels</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                                      <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                      <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Conv_Excitation</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span>
                                         <span class="n">in_channels</span><span class="p">,</span>
                                         <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avgpool</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>  <span class="c1"># shape: [b, c, h, w] to [b, c, 1, 1]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Conv_Squeeze</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>  <span class="c1"># shape: [b, c/2, 1, 1]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Conv_Excitation</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>  <span class="c1"># shape: [b, c, 1, 1]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="c1"># 激活函数z^用sigmoid -&gt; [b,c,1,1]</span>
        <span class="k">return</span> <span class="n">U</span> <span class="o">*</span> <span class="n">z</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="c1"># [b,c,h,w]</span>

<span class="c1"># 输入维度和输出维度一样</span>
<span class="k">class</span> <span class="nc">sSE</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Conv1x1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_channels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Conv1x1</span><span class="p">(</span><span class="n">U</span><span class="p">)</span> <span class="c1"># U:[b,c,h,w] to q:[b,1,h,w]</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">U</span> <span class="o">*</span> <span class="n">q</span> <span class="c1"># [b,c,h,w]</span>

<span class="c1"># 输入维度和输出维度一样</span>
<span class="k">class</span> <span class="nc">csSE</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_channels</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cSE</span> <span class="o">=</span> <span class="n">cSE</span><span class="p">(</span><span class="n">in_channels</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sSE</span> <span class="o">=</span> <span class="n">sSE</span><span class="p">(</span><span class="n">in_channels</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">U</span><span class="p">):</span>
        <span class="n">U_sse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sSE</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="n">U_cse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cSE</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">U_cse</span><span class="o">+</span><span class="n">U_sse</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">64</span>
    <span class="n">in_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>

    <span class="n">cs_se</span> <span class="o">=</span> <span class="n">csSE</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in shape:&quot;</span><span class="p">,</span><span class="n">in_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">out_tensor</span> <span class="o">=</span> <span class="n">cs_se</span><span class="p">(</span><span class="n">in_tensor</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;out shape:&quot;</span><span class="p">,</span> <span class="n">out_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<p><strong>Non-Local Net</strong>|<a href="https://arxiv.org/pdf/1711.07971">论文</a>|<a href="https://github.com/pprp/SimpleCVReproduction/tree/master/Plug-and-play module/attention/Non-local">代码</a>|<a href="https://zhuanlan.zhihu.com/p/102984842">博客详解</a></p>
<p><code>NLNet</code>主要借鉴了传统方法中的非局部均值滤波设计了 Non-Local 全局注意力，虽然效果好， 但是计算量偏大，建议不要在底层网络使用，可以适当在**高层网络**中使用，经过作者实验，证明了其可以应用于图像分类、目标检测、目标分割、姿态识别等视觉任务中，并且效果有不同程度的提升，在**视频分类**上效果很好，在视频分类的任务中效果可观。</p>
<p><img alt="image-20200625212823999" src="../assets/image-20200625212823999.png" /></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 代码见博客详解</span>
</code></pre></div>
<p><strong>GCNet</strong>|<a href="https://arxiv.org/abs/1904.11492">论文</a>|<a href="https://zhuanlan.zhihu.com/p/64988633">博客详解</a></p>
<p>GCNet 主要针对 Non-Local 计算量过大的问题结合了提出了解决方案,使其即能够像NLNet一样有效的对全局上下文建模，又能够像SENet一样轻量。</p>
<p><img alt="image-20200625214859177" src="../assets/image-20200625214859177.png" /></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">nn</span>

<span class="k">class</span> <span class="nc">ContextBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">inplanes</span><span class="p">,</span><span class="n">ratio</span><span class="p">,</span><span class="n">pooling_type</span><span class="o">=</span><span class="s1">&#39;att&#39;</span><span class="p">,</span>
                 <span class="n">fusion_types</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;channel_add&#39;</span><span class="p">,</span> <span class="p">)):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ContextBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="n">valid_fusion_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;channel_add&#39;</span><span class="p">,</span> <span class="s1">&#39;channel_mul&#39;</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">pooling_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;avg&#39;</span><span class="p">,</span> <span class="s1">&#39;att&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fusion_types</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">f</span> <span class="ow">in</span> <span class="n">valid_fusion_types</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fusion_types</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">fusion_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;at least one fusion should be used&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inplanes</span> <span class="o">=</span> <span class="n">inplanes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ratio</span> <span class="o">=</span> <span class="n">ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">planes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">inplanes</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pooling_type</span> <span class="o">=</span> <span class="n">pooling_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fusion_types</span> <span class="o">=</span> <span class="n">fusion_types</span>

        <span class="k">if</span> <span class="n">pooling_type</span> <span class="o">==</span> <span class="s1">&#39;att&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conv_mask</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">inplanes</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">avg_pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;channel_add&#39;</span> <span class="ow">in</span> <span class="n">fusion_types</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_add_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inplanes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">planes</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>  <span class="c1"># yapf: disable</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inplanes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_add_conv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;channel_mul&#39;</span> <span class="ow">in</span> <span class="n">fusion_types</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_mul_conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inplanes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">LayerNorm</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">planes</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>  <span class="c1"># yapf: disable</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">planes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inplanes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_mul_conv</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">spatial_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">batch</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pooling_type</span> <span class="o">==</span> <span class="s1">&#39;att&#39;</span><span class="p">:</span>
            <span class="n">input_x</span> <span class="o">=</span> <span class="n">x</span>
            <span class="c1"># [N, C, H * W]</span>
            <span class="n">input_x</span> <span class="o">=</span> <span class="n">input_x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
            <span class="c1"># [N, 1, C, H * W]</span>
            <span class="n">input_x</span> <span class="o">=</span> <span class="n">input_x</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># [N, 1, H, W]</span>
            <span class="n">context_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_mask</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="c1"># [N, 1, H * W]</span>
            <span class="n">context_mask</span> <span class="o">=</span> <span class="n">context_mask</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="n">width</span><span class="p">)</span>
            <span class="c1"># [N, 1, H * W]</span>
            <span class="n">context_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">context_mask</span><span class="p">)</span>
            <span class="c1"># [N, 1, H * W, 1]</span>
            <span class="n">context_mask</span> <span class="o">=</span> <span class="n">context_mask</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># [N, 1, C, 1]</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">input_x</span><span class="p">,</span> <span class="n">context_mask</span><span class="p">)</span>
            <span class="c1"># [N, C, 1, 1]</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># [N, C, 1, 1]</span>
            <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_pool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># [N, C, 1, 1]</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_pool</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_mul_conv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># [N, C, 1, 1]</span>
            <span class="n">channel_mul_term</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_mul_conv</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">*</span> <span class="n">channel_mul_term</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_add_conv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># [N, C, 1, 1]</span>
            <span class="n">channel_add_term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_add_conv</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span> <span class="o">+</span> <span class="n">channel_add_term</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">in_tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">12</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">))</span>

    <span class="n">cb</span> <span class="o">=</span> <span class="n">ContextBlock</span><span class="p">(</span><span class="n">inplanes</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mf">16.</span><span class="p">,</span><span class="n">pooling_type</span><span class="o">=</span><span class="s1">&#39;att&#39;</span><span class="p">)</span>

    <span class="n">out_tensor</span> <span class="o">=</span> <span class="n">cb</span><span class="p">(</span><span class="n">in_tensor</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">in_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">out_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<p><strong>CCNet</strong>|<a href="https://arxiv.org/abs/1811.11721">论文</a>|<a href="https://github.com/speedinghzl/CCNet">代码</a>|<a href="https://zhuanlan.zhihu.com/p/108584034">博客详解</a>|<a href="https://github.com/pprp/SimpleCVReproduction/blob/master/Plug-and-play module/attention/CCNet/ccnet.py">代码简单实现</a></p>
<p>由<code>Non-Local</code> 发展而来的注意力模块，其特殊之处在纵横交叉关注模块，可以以更有效的方 式从远程依赖中获取上下文信息。</p>
<p><img alt="image-20200625220336794" src="../assets/image-20200625220336794.png" /></p>
<p><strong>CBAM</strong>|<a href="https://arxiv.org/abs/1807.06521">论文</a>|<a href="https://zhuanlan.zhihu.com/p/99261200">ResNet中加入该模块</a>|<a href="https://zhuanlan.zhihu.com/p/102035273">博客介绍</a></p>
<p>将空间注意力机制和通道注意力机制进行串联</p>
<p><img alt="image-20200625220927760" src="../assets/image-20200625220927760.png" /></p>
<ul>
<li>输入是 <code>H×W×C</code>特征<code>F，</code>分别进行一个空间的全局平均池化和最大池化得到两个 <code>1×1×C</code> 的通道描述。</li>
<li>再将它们分别送入一个两层的神经网络，第一层神经元个数为 <code>C/r</code>，激活函数为 <code>Relu</code>，第二层神经元个数为<code>C</code>。注意，这个两层的神经网络是共享的。</li>
<li>再将得到的两个特征**相加**后经过一个 <code>Sigmoid</code> 激活函数得到权重系数 Mc。</li>
<li>最后，拿权重系数和原来的特征 <code>F</code> 相乘即可得到缩放后的新特征。</li>
</ul>
<p><img alt="image-20200625220954274" src="../assets/image-20200625220954274.png" /></p>
<ul>
<li>输入一个 <code>H×W×C</code> 的特征 <code>F‘</code>，分别进行一个通道维度的平均池化和最大池化得到两个<code>H×W×1</code> 的通道描述，将这两个描述按照通道拼接在一起。</li>
<li>然后，经过一个 <code>7×7</code> 的卷积层，激活函数为 <code>Sigmoid</code>，得到权重系数 Ms。</li>
<li>最后，拿权重系数和特征 F’ 相乘即可得到缩放后的新特征。</li>
</ul>
<p><img alt="image-20200625221012198" src="../assets/image-20200625221012198.png" /></p>
<ul>
<li>通道注意力和空间注意力这两个模块可以以并行或者串联的方式组合在一起，但是作者发现串联组合并且将通道注意力放在前面可以取得更好的效果。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>


<span class="k">def</span> <span class="nf">conv3x3</span><span class="p">(</span><span class="n">in_planes</span><span class="p">,</span> <span class="n">out_planes</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="s2">&quot;3x3 convolution with padding&quot;</span>
    <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_planes</span><span class="p">,</span>
                     <span class="n">out_planes</span><span class="p">,</span>
                     <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                     <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span>
                     <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ChannelAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_planes</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ChannelAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">avg_pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveAvgPool2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_pool</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">AdaptiveMaxPool2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sharedMLP</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_planes</span><span class="p">,</span> <span class="n">in_planes</span> <span class="o">//</span> <span class="n">ratio</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> 
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_planes</span> <span class="o">//</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">in_planes</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">avgout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharedMLP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avg_pool</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">maxout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sharedMLP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_pool</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">avgout</span> <span class="o">+</span> <span class="n">maxout</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SpatialAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">7</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpatialAttention</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">kernel_size</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="s2">&quot;kernel size must be 3 or 7&quot;</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="mi">3</span> <span class="k">if</span> <span class="n">kernel_size</span> <span class="o">==</span> <span class="mi">7</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sigmoid</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">avgout</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">maxout</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">avgout</span><span class="p">,</span> <span class="n">maxout</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BasicBlock</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="n">expansion</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inplanes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">downsample</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BasicBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">conv3x3</span><span class="p">(</span><span class="n">inplanes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relu</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">conv3x3</span><span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="n">planes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bn2</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ca</span> <span class="o">=</span> <span class="n">ChannelAttention</span><span class="p">(</span><span class="n">planes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sa</span> <span class="o">=</span> <span class="n">SpatialAttention</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span> <span class="o">=</span> <span class="n">downsample</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">residual</span> <span class="o">=</span> <span class="n">x</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ca</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">*</span> <span class="n">out</span>  <span class="c1"># 广播机制</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sa</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">*</span> <span class="n">out</span>  <span class="c1"># 广播机制</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;downsampling&quot;</span><span class="p">)</span>
            <span class="n">residual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">downsample</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">residual</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">+=</span> <span class="n">residual</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">downsample</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">32</span><span class="p">))</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">BasicBlock</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">downsample</span><span class="o">=</span><span class="n">downsample</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div>
<p><strong>BAM</strong>|<a href="https://arxiv.org/abs/1807.06514">论文</a></p>
<p>和 <code>CBAM</code> 同一个作者，将通道注意力和空间注意力用并联的方式连接</p>
<p><img alt="image-20200625223323247" src="../assets/image-20200625223323247.png" /></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>


<span class="k">class</span> <span class="nc">Flatten</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ChannelGate</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gate_channel</span><span class="p">,</span> <span class="n">reduction_ratio</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ChannelGate</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_c</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_c</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s1">&#39;flatten&#39;</span><span class="p">,</span> <span class="n">Flatten</span><span class="p">())</span>

        <span class="n">gate_channels</span> <span class="o">=</span> <span class="p">[</span><span class="n">gate_channel</span><span class="p">]</span>  <span class="c1"># eg 64</span>
        <span class="n">gate_channels</span> <span class="o">+=</span> <span class="p">[</span><span class="n">gate_channel</span> <span class="o">//</span> <span class="n">reduction_ratio</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_layers</span>  <span class="c1"># eg 4</span>
        <span class="n">gate_channels</span> <span class="o">+=</span> <span class="p">[</span><span class="n">gate_channel</span><span class="p">]</span>  <span class="c1"># 64</span>
        <span class="c1"># gate_channels: [64, 4, 4]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gate_channels</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gate_c</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
                <span class="s1">&#39;gate_c_fc_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">gate_channels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">gate_channels</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gate_c</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s1">&#39;gate_c_bn_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                                   <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="n">gate_channels</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gate_c</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s1">&#39;gate_c_relu_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gate_c</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s1">&#39;gate_c_fc_final&#39;</span><span class="p">,</span>
                               <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">gate_channels</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">gate_channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">avg_pool</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">avg_pool2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">stride</span><span class="o">=</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_c</span><span class="p">(</span><span class="n">avg_pool</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SpatialGate</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">gate_channel</span><span class="p">,</span>
                 <span class="n">reduction_ratio</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
                 <span class="n">dilation_conv_num</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">dilation_val</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpatialGate</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_s</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gate_s</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
            <span class="s1">&#39;gate_s_conv_reduce0&#39;</span><span class="p">,</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">gate_channel</span><span class="p">,</span>
                      <span class="n">gate_channel</span> <span class="o">//</span> <span class="n">reduction_ratio</span><span class="p">,</span>
                      <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_s</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s1">&#39;gate_s_bn_reduce0&#39;</span><span class="p">,</span>
                               <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">gate_channel</span> <span class="o">//</span> <span class="n">reduction_ratio</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gate_s</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s1">&#39;gate_s_relu_reduce0&#39;</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>

        <span class="c1"># 进行多个空洞卷积，丰富感受野</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dilation_conv_num</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gate_s</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
                <span class="s1">&#39;gate_s_conv_di_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">gate_channel</span> <span class="o">//</span> <span class="n">reduction_ratio</span><span class="p">,</span>
                          <span class="n">gate_channel</span> <span class="o">//</span> <span class="n">reduction_ratio</span><span class="p">,</span>
                          <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                          <span class="n">padding</span><span class="o">=</span><span class="n">dilation_val</span><span class="p">,</span>
                          <span class="n">dilation</span><span class="o">=</span><span class="n">dilation_val</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gate_s</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
                <span class="s1">&#39;gate_s_bn_di_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">gate_channel</span> <span class="o">//</span> <span class="n">reduction_ratio</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gate_s</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span><span class="s1">&#39;gate_s_relu_di_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gate_s</span><span class="o">.</span><span class="n">add_module</span><span class="p">(</span>
            <span class="s1">&#39;gate_s_conv_final&#39;</span><span class="p">,</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">gate_channel</span> <span class="o">//</span> <span class="n">reduction_ratio</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">gate_s</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">expand_as</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BAM</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gate_channel</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BAM</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel_att</span> <span class="o">=</span> <span class="n">ChannelGate</span><span class="p">(</span><span class="n">gate_channel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_att</span> <span class="o">=</span> <span class="n">SpatialGate</span><span class="p">(</span><span class="n">gate_channel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">att</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">F</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_att</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_att</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">att</span> <span class="o">*</span> <span class="n">x</span>
</code></pre></div>
<h3 id="gpu">自动检测GPU<a class="headerlink" href="#gpu" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">auto_select_gpu</span><span class="p">(</span><span class="n">mem_bound</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">utility_bound</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">gpus</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">selected_gpus</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="kn">import</span> <span class="nn">re</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="k">if</span> <span class="s1">&#39;CUDA_VISIBLE_DEVCIES&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">selected_gpus</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mem_trace</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">utility_trace</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span> <span class="c1"># sample 5 times</span>
            <span class="n">info</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s1">&#39;nvidia-smi&#39;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">mem</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">s</span><span class="p">[:</span><span class="o">-</span><span class="mi">5</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\d+MiB\s/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">info</span><span class="p">)]</span>
            <span class="n">utility</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\d+&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">s</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;\d+%\s+Default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">info</span><span class="p">)]</span>
            <span class="n">mem_trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span>
            <span class="n">utility_trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">utility</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mem_trace</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">utility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">utility_trace</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">utility</span><span class="p">))</span>
        <span class="n">nGPU</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">utility</span><span class="p">)</span>
        <span class="n">ideal_gpus</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nGPU</span><span class="p">)</span> <span class="k">if</span> <span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">mem_bound</span> <span class="ow">and</span> <span class="n">utility</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">utility_bound</span> <span class="ow">and</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">gpus</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ideal_gpus</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No gpu is available!!!&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This code will use gpus:</span><span class="si">{</span><span class="n">ideal_gpus</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">selected_gpus</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ideal_gpus</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selected_gpus</span> <span class="o">=</span> <span class="n">selected_gpus</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Setting GPU: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">selected_gpus</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CUDA_VISIBLE_DEVICES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">selected_gpus</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">selected_gpus</span>
</code></pre></div>
<h3 id="tsne">TSNE可视化<a class="headerlink" href="#tsne" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">sklearn</span> <span class="kn">import</span> <span class="n">manifold</span><span class="p">,</span> <span class="n">decomposition</span>
<span class="kn">from</span> <span class="nn">skimage</span> <span class="kn">import</span> <span class="n">io</span><span class="p">,</span> <span class="n">transform</span><span class="p">,</span> <span class="n">color</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patheffects</span> <span class="k">as</span> <span class="nn">PathEffects</span>
<span class="kn">from</span> <span class="nn">matplotlib.offsetbox</span> <span class="kn">import</span> <span class="n">OffsetImage</span><span class="p">,</span> <span class="n">AnnotationBbox</span>
<span class="kn">from</span> <span class="nn">pylab</span> <span class="kn">import</span> <span class="n">mpl</span>
<span class="n">myfont</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">font_manager</span><span class="o">.</span><span class="n">FontProperties</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="s1">&#39;/usr/share/fonts/truetype/droid/DroidSansFallbackFull.ttf&#39;</span><span class="p">)</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;axes.unicode_minus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">pairwise_distances</span>

<span class="n">caffe_root</span> <span class="o">=</span> <span class="s1">&#39;/data_2/malin/SOFTWARES/caffe-all&#39;</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">string</span><span class="o">,</span> <span class="nn">random</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">caffe_root</span><span class="o">+</span><span class="s1">&#39;/python&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">caffe</span><span class="o">,</span> <span class="nn">cv2</span><span class="o">,</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">imscatter</span><span class="p">(</span><span class="n">img_paths</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">imgbox_size</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">zoom</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Show images instead of plot points while doing tsne in Python</span>
<span class="sd">    Input:</span>
<span class="sd">        show_img_lists: image path lists n * 1</span>
<span class="sd">        X, Y: x and y position lists got from t-sne, x is n * 1, y is n * 1</span>
<span class="sd">        imgbox_size: the size of image showed in the cluster picture</span>
<span class="sd">        ax</span>
<span class="sd">        zoom</span>
<span class="sd">    Output:</span>
<span class="sd">        artists</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">XY</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">artists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">img_paths</span><span class="p">)):</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_paths</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">imgbox_size</span><span class="p">)</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">OffsetImage</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">)</span>
        <span class="n">ab</span> <span class="o">=</span> <span class="n">AnnotationBbox</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">XY</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">artists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">ab</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">update_datalim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">]))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">autoscale</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">artists</span>

<span class="k">def</span> <span class="nf">visual_feature_space</span><span class="p">(</span><span class="n">img_paths</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fea_dim</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="n">classId</span><span class="p">,</span> <span class="n">imgbox_size</span><span class="p">,</span> <span class="n">zoom</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">):</span>
    <span class="c1"># compute the tsne map</span>
    <span class="n">num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="n">fea_dim</span><span class="p">))</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
        <span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">Y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">pre_matrix</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">)</span>
    <span class="n">pre_matrix</span> <span class="o">=</span> <span class="n">pre_matrix</span> <span class="o">+</span> <span class="mf">1e-10</span>

    <span class="n">tsne</span> <span class="o">=</span> <span class="n">manifold</span><span class="o">.</span><span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;precomputed&#39;</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">pre_matrix</span><span class="p">)</span>

    <span class="c1"># draw</span>
    <span class="n">palette</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s1">&#39;hls&#39;</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">))</span>

    <span class="c1"># We create a scatter plot.</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

    <span class="c1"># We draw image ins,这个用不用看自己选择</span>
    <span class="c1">#imscatter(img_paths, X[:,0], X[:,1], imgbox_size, ax=ax, zoom=zoom)</span>

    <span class="n">sc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">labels</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

    <span class="c1"># We add the labels for each digit.</span>
    <span class="n">txts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_classes</span><span class="p">):</span>
        <span class="c1"># Position of each label.</span>
        <span class="n">xtext</span><span class="p">,</span> <span class="n">ytext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">labels</span><span class="o">==</span><span class="n">i</span><span class="p">,:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xtext</span><span class="p">,</span> <span class="n">ytext</span><span class="p">,</span> <span class="n">classId</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fontproperties</span><span class="o">=</span><span class="n">myfont</span><span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">set_path_effects</span><span class="p">([</span><span class="n">PathEffects</span><span class="o">.</span><span class="n">Stroke</span><span class="p">(</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">foreground</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">),</span> <span class="n">PathEffects</span><span class="o">.</span><span class="n">Normal</span><span class="p">()])</span>
        <span class="n">txts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">txts</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">xxx</span> <span class="c1"># 注意浅拷贝和深拷贝问题</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">xxx</span> <span class="c1"># labels标签</span>
    <span class="n">img_paths</span> <span class="o">=</span> <span class="n">xxx</span> <span class="c1"># 使用img_scatter时候需要用到</span>
    <span class="n">visual_feature_space</span><span class="p">(</span><span class="n">img_paths</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">fea_dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">classId</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="n">imgbox_size</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">zoom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;cosine&#39;</span><span class="p">)</span>
</code></pre></div>
<h3 id="-gradcam">卷积可视化-GradCAM<a class="headerlink" href="#-gradcam" title="Permanent link">&para;</a></h3>
<p><a href="http://spytensor.com/index.php/archives/20/?fsbuba=v3lnw1">卷积可视化-GradCAM-keras/pytorch</a>|<a href="https://github.com/gautamMalu/caffe-gradCAM">caffe版本</a>:caffe默认没有损失就不算梯度<a href="https://www.jianshu.com/p/f93e462c7286">解决</a></p>
<div class="highlight"><pre><span></span><code><span class="c1"># caffe版本,caffe 默认没有损失就不算梯度。所以要在deploy中添加force_backward: true</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>

<span class="n">class_nums</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">resize_</span> <span class="o">=</span> <span class="p">(</span><span class="mi">227</span><span class="p">,</span><span class="mi">227</span><span class="p">)</span>
<span class="n">vis_layer</span> <span class="o">=</span> <span class="s1">&#39;pool5&#39;</span> <span class="c1"># visualization layer</span>

<span class="c1">#Perform a backward pass for the cat class (281)</span>
<span class="n">net</span><span class="o">.</span><span class="n">blobs</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">transformed_image</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">forward</span><span class="p">()</span>

<span class="n">output_prob</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="s1">&#39;prob&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># the output probability vector for the first image in the batch</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;predicted class is:&#39;</span><span class="p">,</span> <span class="n">output_prob</span><span class="o">.</span><span class="n">argmax</span><span class="p">())</span>

<span class="n">label_index</span> <span class="o">=</span> <span class="n">output_prob</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span>
<span class="n">caffeLabel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">class_nums</span><span class="p">))</span>
<span class="n">caffeLabel</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">label_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="n">grads</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">backward</span><span class="p">(</span><span class="n">diffs</span><span class="o">=</span><span class="p">[</span><span class="n">vis_layer</span><span class="p">],</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;prob&#39;</span><span class="p">:</span><span class="n">caffeLabel</span><span class="p">})</span>
<span class="c1">#bw=net.backward(diffs=[vis_layer],**{net.outputs[0]: caffeLabel})</span>
<span class="n">vis_grad</span><span class="o">=</span> <span class="n">grads</span><span class="p">[</span><span class="s1">&#39;pool5&#39;</span><span class="p">]</span> <span class="c1"># gradients of pool5 layer with respect to output class</span>
<span class="n">vis_grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">vis_grad</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># removing the extra dimension</span>
<span class="n">mean_grads</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vis_grad</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="c1"># mean of gradients</span>


<span class="n">activations</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">blobs</span><span class="p">[</span><span class="n">vis_layer</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
<span class="n">activations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">activations</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">n_nodes</span> <span class="o">=</span> <span class="n">activations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># number of nodels</span>
<span class="n">vis_size</span> <span class="o">=</span> <span class="n">activations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c1">#visualization shape</span>
<span class="n">vis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">activations</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>


<span class="c1">#generating saliency image</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_nodes</span><span class="p">):</span>
    <span class="n">activation</span> <span class="o">=</span> <span class="n">activations</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">mean_grads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">weighted_activation</span> <span class="o">=</span> <span class="n">activation</span><span class="o">*</span><span class="n">weight</span>
    <span class="n">vis</span> <span class="o">+=</span> <span class="n">weighted_activation</span>

<span class="c1"># We select only those activation which has positively contributed in prediction of given class</span>

<span class="n">heatmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>   <span class="c1"># relu</span>
<span class="n">heatmap</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">heatmap</span><span class="p">)</span>
<span class="n">src_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">xxx</span><span class="p">,</span><span class="n">resize_</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>
<span class="n">src_img</span> <span class="o">=</span> <span class="n">src_img</span><span class="p">[:,:,</span><span class="kc">None</span><span class="p">]</span> <span class="k">if</span> <span class="n">src_img</span><span class="o">.</span><span class="n">ndim</span><span class="o">==</span><span class="mi">1</span> <span class="k">else</span> <span class="n">src_img</span>
<span class="n">heatmap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">heatmap</span><span class="p">,</span><span class="n">src_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">heatmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">heatmap</span><span class="p">)</span>
<span class="n">heatmap</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">applyColorMap</span><span class="p">(</span><span class="n">heatmap</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">COLORMAP_JET</span><span class="p">)</span> <span class="c1"># 将热力图应用于原始图像</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">heatmap</span> <span class="o">*</span> <span class="mf">0.4</span> <span class="o">+</span> <span class="n">src_img</span> <span class="c1"># 注意此时heatmap是三通道，必须保证src_img是三维</span>
</code></pre></div>
<h3 id="_3">网络结构可视化工具<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p><a href="https://lutzroeder.github.io/netron/">https://lutzroeder.github.io/netron/</a> ==&gt; <a href="https://netron.app/">https://netron.app/</a></p>
<h3 id="voc">VOC数据集制作<a class="headerlink" href="#voc" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">import</span> <span class="nn">cv2</span>

<span class="k">def</span> <span class="nf">GetAnnotBoxLoc</span><span class="p">(</span><span class="n">AnotPath</span><span class="p">):</span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">ElementTree</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">AnotPath</span><span class="p">)</span>
    <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
    <span class="n">ObjectSet</span><span class="o">=</span><span class="n">root</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">)</span>
    <span class="n">ObjBndBoxSet</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">Object</span> <span class="ow">in</span> <span class="n">ObjectSet</span><span class="p">:</span>
        <span class="n">BndBox</span><span class="o">=</span><span class="n">Object</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;bndbox&#39;</span><span class="p">)</span>
        <span class="n">x1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">BndBox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;xmin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">y1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">BndBox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ymin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">x2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">BndBox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;xmax&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">BndBox</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ymax&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">ObjBndBoxSet</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">y2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ObjBndBoxSet</span>

<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;new_Annotations&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s2">&quot;new_JPEGImages&quot;</span><span class="p">,</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">img_path_new</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;JPEGImages/*.jpg&quot;</span><span class="p">):</span>
    <span class="n">save_img_name</span> <span class="o">=</span> <span class="n">img_path_new</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;JPEGImages&quot;</span><span class="p">,</span><span class="s2">&quot;new_JPEGImages&quot;</span><span class="p">)</span>
    <span class="n">img_new</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">img_path_new</span><span class="p">)</span>
    <span class="n">target_size</span> <span class="o">=</span> <span class="mi">320</span>
    <span class="n">im_scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">target_size</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">img_new</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">im_scale</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">img_new</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_new</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">,</span><span class="n">fx</span><span class="o">=</span><span class="n">im_scale</span><span class="p">,</span><span class="n">fy</span><span class="o">=</span><span class="n">im_scale</span><span class="p">,</span><span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>
    <span class="n">image_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">img_path_new</span><span class="p">)</span>
    <span class="n">xml_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;Annotations&quot;</span><span class="p">,</span><span class="n">image_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s2">&quot;.xml&quot;</span><span class="p">)</span>
    <span class="n">height</span><span class="p">,</span><span class="n">width</span> <span class="o">=</span> <span class="n">img_new</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">img_boxs</span> <span class="o">=</span> <span class="n">GetAnnotBoxLoc</span><span class="p">(</span><span class="n">xml_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img_boxs</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">10</span><span class="p">:</span>
        <span class="k">continue</span>
    <span class="n">cv2</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">save_img_name</span><span class="p">,</span><span class="n">img_new</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;new_Annotations/</span><span class="si">{</span><span class="n">image_name</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">.xml&quot;</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">xml_file</span><span class="p">:</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&lt;?xml version=&#39;1.0&#39; encoding=&#39;us-ascii&#39;?&gt;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;annotation&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;folder&gt;simple&lt;/folder&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;filename&gt;&#39;</span><span class="o">+</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">image_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">+</span><span class="s1">&#39;&lt;/filename&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;source&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;database&gt;&#39;</span> <span class="o">+</span><span class="s1">&#39;The simple Database&#39;</span> <span class="o">+</span> <span class="s1">&#39;&lt;/database&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;annotation&gt;&#39;</span> <span class="o">+</span><span class="s1">&#39;simple&#39;</span> <span class="o">+</span> <span class="s1">&#39;&lt;/annotation&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;image&gt;head&lt;/image&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;flickrid&gt;325991873&lt;/flickrid&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;/source&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;owner&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;flickrid&gt;archin&lt;/flickrid&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;name&gt;?&lt;/name&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;/owner&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;size&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;width&gt;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/width&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;height&gt;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">height</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/height&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;depth&gt;3&lt;/depth&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;/size&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;segmented&gt;0&lt;/segmented&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># write the region of text on xml file</span>
        <span class="k">for</span> <span class="n">spt</span> <span class="ow">in</span> <span class="n">img_boxs</span><span class="p">:</span>
            <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;object&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="c1"># 修改名称</span>
            <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;name&gt;head&lt;/name&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;pose&gt;Unspecified&lt;/pose&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;truncated&gt;0&lt;/truncated&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;difficult&gt;0&lt;/difficult&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;bndbox&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;xmin&gt;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">spt</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">im_scale</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;&lt;/xmin&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;ymin&gt;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">spt</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">im_scale</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;&lt;/ymin&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;xmax&gt;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">spt</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">im_scale</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;&lt;/xmax&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t\t</span><span class="s1">&lt;ymax&gt;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">spt</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span><span class="o">*</span><span class="n">im_scale</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;&lt;/ymax&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t\t</span><span class="s1">&lt;/bndbox&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&lt;/object&gt;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">xml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;&lt;/annotation&gt;&#39;</span><span class="p">)</span>
</code></pre></div>
<h3 id="anchoryolov3">数据集anchor计算(yolov3)<a class="headerlink" href="#anchoryolov3" title="Permanent link">&para;</a></h3>
<p><a href="https://mp.weixin.qq.com/s/1v84QyvH-k0lzRPOEyaBgw">博客链接</a></p>
<div class="highlight"><pre><span></span><code><span class="c1">#coding=utf-8</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">glob</span>

<span class="k">def</span> <span class="nf">iou</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">clusters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    计算一个ground truth边界盒和k个先验框(Anchor)的交并比(IOU)值。</span>
<span class="sd">    参数box: 元组或者数据，代表ground truth的长宽。</span>
<span class="sd">    参数clusters: 形如(k,2)的numpy数组，其中k是聚类Anchor框的个数</span>
<span class="sd">    返回：ground truth和每个Anchor框的交并比。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">clusters</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">clusters</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Box has no area&quot;</span><span class="p">)</span>
    <span class="n">intersection</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span>
    <span class="n">box_area</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">cluster_area</span> <span class="o">=</span> <span class="n">clusters</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">clusters</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">iou_</span> <span class="o">=</span> <span class="n">intersection</span> <span class="o">/</span> <span class="p">(</span><span class="n">box_area</span> <span class="o">+</span> <span class="n">cluster_area</span> <span class="o">-</span> <span class="n">intersection</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">iou_</span>

<span class="k">def</span> <span class="nf">avg_iou</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">clusters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    计算一个ground truth和k个Anchor的交并比的均值。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">iou</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">clusters</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">boxes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>

<span class="k">def</span> <span class="nf">kmeans</span><span class="p">(</span><span class="n">boxes</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    利用IOU值进行K-means聚类</span>
<span class="sd">    参数boxes: 形状为(r, 2)的ground truth框，其中r是ground truth的个数</span>
<span class="sd">    参数k: Anchor的个数</span>
<span class="sd">    参数dist: 距离函数</span>
<span class="sd">    返回值：形状为(k, 2)的k个Anchor框</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 即是上面提到的r</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">boxes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># 距离数组，计算每个ground truth和k个Anchor的距离</span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
    <span class="c1"># 上一次每个ground truth&quot;距离&quot;最近的Anchor索引</span>
    <span class="n">last_clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,))</span>
    <span class="c1"># 设置随机数种子</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>

    <span class="c1"># 初始化聚类中心，k个簇，从r个ground truth随机选k个</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">boxes</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span>
    <span class="c1"># 开始聚类</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="c1"># 计算每个ground truth和k个Anchor的距离，用1-IOU(box,anchor)来计算</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
            <span class="n">distances</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">iou</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="n">row</span><span class="p">],</span> <span class="n">clusters</span><span class="p">)</span>
        <span class="c1"># 对每个ground truth，选取距离最小的那个Anchor，并存下索引</span>
        <span class="n">nearest_clusters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># 如果当前每个ground truth&quot;距离&quot;最近的Anchor索引和上一次一样，聚类结束</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">last_clusters</span> <span class="o">==</span> <span class="n">nearest_clusters</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="k">break</span>
        <span class="c1"># 更新簇中心为簇里面所有的ground truth框的均值</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
            <span class="n">clusters</span><span class="p">[</span><span class="n">cluster</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="n">nearest_clusters</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># 更新每个ground truth&quot;距离&quot;最近的Anchor索引</span>
        <span class="n">last_clusters</span> <span class="o">=</span> <span class="n">nearest_clusters</span>

    <span class="k">return</span> <span class="n">clusters</span>

<span class="c1"># 加载自己的数据集，只需要所有labelimg标注出来的xml文件即可</span>
<span class="k">def</span> <span class="nf">load_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">xml_file</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/*xml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">)):</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">xml_file</span><span class="p">)</span>
        <span class="c1"># 图片高度</span>
        <span class="n">height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;./size/height&quot;</span><span class="p">))</span>
        <span class="c1"># 图片宽度</span>
        <span class="n">width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;./size/width&quot;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">iter</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="p">):</span>
            <span class="c1"># 偏移量,这里已经是归一化后的x、y</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;bndbox/xmin&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">width</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;bndbox/ymin&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">height</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;bndbox/xmax&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">width</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">findtext</span><span class="p">(</span><span class="s2">&quot;bndbox/ymax&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="n">height</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">xmin</span><span class="p">)</span>
            <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">ymin</span><span class="p">)</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">xmax</span><span class="p">)</span>
            <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">ymax</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">xmax</span> <span class="o">==</span> <span class="n">xmin</span> <span class="ow">or</span> <span class="n">ymax</span> <span class="o">==</span> <span class="n">ymin</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">xml_file</span><span class="p">)</span>
            <span class="c1"># 将Anchor的长宽放入dateset，运行kmeans获得Anchor</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">-</span> <span class="n">ymin</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>

    <span class="n">ANNOTATIONS_PATH</span> <span class="o">=</span> <span class="s2">&quot;F:\Annotations&quot;</span> <span class="c1">#xml文件所在文件夹</span>
    <span class="n">CLUSTERS</span> <span class="o">=</span> <span class="mi">9</span> <span class="c1">#聚类数量，anchor数量</span>
    <span class="n">INPUTDIM</span> <span class="o">=</span> <span class="mi">416</span> <span class="c1">#输入网络大小</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">load_dataset</span><span class="p">(</span><span class="n">ANNOTATIONS_PATH</span><span class="p">)</span>
    <span class="c1"># kmeans函数得到的结果实际上是归一化到0-1之间的</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">kmeans</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">CLUSTERS</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Boxes:&#39;</span><span class="p">)</span>
    <span class="c1"># 然后Anchor的输出是在此基础上乘以输入分辨率的大小(模型输出),所以Anchor和图片的输入分辨率是有关的</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">*</span><span class="n">INPUTDIM</span><span class="p">)</span>    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Accuracy: </span><span class="si">{:.2f}</span><span class="s2">%&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">avg_iou</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>       
    <span class="n">final_anchors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">out</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">out</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Before Sort Ratios:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">final_anchors</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;After Sort Ratios:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">final_anchors</span><span class="p">)))</span>
</code></pre></div>
<h3 id="map">MAP计算库<a class="headerlink" href="#map" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/Cartucho/mAP">code</a></p>
<h3 id="_4">人脸图片扩充<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p><img alt="image-20210303153000311" src="../assets/image-20210303153000311.png" /></p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">merge_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span>  <span class="mf">1.0</span> <span class="o">/</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">scale_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">scale_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
        <span class="n">img_scale</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">scale_w</span><span class="p">,</span> <span class="n">scale_h</span><span class="p">))</span>
        <span class="c1"># import pdb; pdb.set_trace()</span>
        <span class="n">bboxes_scale</span> <span class="o">=</span> <span class="n">bboxes</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="n">merge_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">scale_h</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">scale_w</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">img_scale</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">merge_bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">flip</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">flip</span><span class="p">:</span>
                <span class="n">img_scale</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">img_scale</span><span class="p">,</span> <span class="n">flip</span><span class="p">)</span>
                <span class="n">bboxes_scale</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">img_scale</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">bboxes_scale</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span>

            <span class="n">merge_img</span><span class="p">[(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_h</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_h</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_w</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_w</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">img_scale</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_w</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_h</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_w</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_h</span><span class="p">])</span>
            <span class="n">merge_bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">merge_bboxes</span><span class="p">,</span> <span class="n">bboxes_scale</span> <span class="o">+</span> <span class="n">offset</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">merge_img</span><span class="p">,</span> <span class="n">merge_bboxes</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>

    <span class="n">img_scale</span><span class="p">,</span> <span class="n">bboxes_scale</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">merge_image</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">bboxes</span><span class="p">,</span> <span class="n">scale</span><span class="o">*</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">scale</span>
    <span class="n">scale_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">scale_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">merge_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">scale_h</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">scale_w</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">img_scale</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">merge_bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

    <span class="n">pos</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">cut_ymin</span><span class="p">,</span><span class="n">cut_ymax</span><span class="p">,</span><span class="n">cut_xmin</span><span class="p">,</span><span class="n">cut_xmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_h</span><span class="p">,(</span><span class="n">pos</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_h</span><span class="p">,</span> <span class="p">(</span><span class="n">pos</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_w</span><span class="p">,(</span><span class="n">pos</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_w</span>
    <span class="n">y_pad</span> <span class="o">=</span> <span class="n">img_scale</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">cut_ymax</span> <span class="o">-</span> <span class="n">cut_ymin</span><span class="p">)</span>
    <span class="n">x_pad</span> <span class="o">=</span> <span class="n">img_scale</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">cut_xmax</span> <span class="o">-</span> <span class="n">cut_xmin</span><span class="p">)</span>
    <span class="n">merge_img</span><span class="p">[</span><span class="n">cut_ymin</span><span class="p">:</span><span class="n">cut_ymax</span><span class="o">+</span><span class="n">y_pad</span><span class="p">,</span><span class="n">cut_xmin</span><span class="p">:</span><span class="n">cut_xmax</span><span class="o">+</span><span class="n">x_pad</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">img_scale</span>

    <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">pos</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_w</span><span class="p">,</span> <span class="p">(</span><span class="n">pos</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_h</span><span class="p">,</span> <span class="p">(</span><span class="n">pos</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_w</span><span class="p">,</span> <span class="p">(</span><span class="n">pos</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_h</span><span class="p">])</span>
    <span class="n">merge_bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">merge_bboxes</span><span class="p">,</span> <span class="n">bboxes_scale</span> <span class="o">+</span> <span class="n">offset</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">img_scale</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">scale_w</span><span class="p">,</span> <span class="n">scale_h</span><span class="p">))</span>
    <span class="n">bboxes_scale</span> <span class="o">=</span> <span class="n">bboxes</span> <span class="o">*</span> <span class="n">scale</span>


    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">pos</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">flip</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">flip</span><span class="p">:</span>
            <span class="n">img_scale</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">img_scale</span><span class="p">,</span> <span class="n">flip</span><span class="p">)</span>
            <span class="n">bboxes_scale</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">img_scale</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">bboxes_scale</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">merge_img</span><span class="p">[(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_h</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_h</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_w</span> <span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_w</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">img_scale</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_w</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_h</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_w</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale_h</span><span class="p">])</span>
        <span class="n">merge_bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">merge_bboxes</span><span class="p">,</span> <span class="n">bboxes_scale</span> <span class="o">+</span> <span class="n">offset</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">merge_img</span><span class="p">,</span> <span class="n">merge_bboxes</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">expand_rect</span><span class="p">(</span><span class="n">merge_img</span><span class="p">,</span><span class="n">merge_bboxes</span><span class="p">,</span><span class="n">img</span><span class="p">,</span><span class="n">img_boxs</span><span class="p">,</span><span class="n">expand_img_num</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">src_h</span><span class="p">,</span><span class="n">src_w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">merge_h</span><span class="p">,</span><span class="n">merge_w</span> <span class="o">=</span> <span class="n">merge_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">src_h</span><span class="o">&gt;=</span><span class="n">src_w</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">img</span><span class="p">]</span><span class="o">*</span><span class="n">expand_img_num</span><span class="p">)</span>
        <span class="n">im_scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">merge_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">img_boxs</span> <span class="o">=</span> <span class="n">img_boxs</span><span class="o">*</span><span class="n">im_scale</span>
        <span class="n">temp_boxs</span> <span class="o">=</span> <span class="n">img_boxs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">expand_img_num</span><span class="p">):</span>
            <span class="n">temp_boxs</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">src_h</span><span class="o">*</span><span class="n">im_scale</span>
            <span class="n">img_boxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">img_boxs</span><span class="p">,</span><span class="n">temp_boxs</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">img</span><span class="p">]</span><span class="o">*</span><span class="n">expand_img_num</span><span class="p">)</span>
        <span class="n">im_scale</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">merge_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">img_boxs</span> <span class="o">=</span> <span class="n">img_boxs</span><span class="o">*</span><span class="n">im_scale</span>
        <span class="n">temp_boxs</span> <span class="o">=</span> <span class="n">img_boxs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">expand_img_num</span><span class="p">):</span>
            <span class="n">temp_boxs</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">src_w</span><span class="o">*</span><span class="n">im_scale</span>
            <span class="n">img_boxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">img_boxs</span><span class="p">,</span><span class="n">temp_boxs</span><span class="p">])</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fx</span><span class="o">=</span><span class="n">im_scale</span><span class="p">,</span><span class="n">fy</span><span class="o">=</span><span class="n">im_scale</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">cv2</span><span class="o">.</span><span class="n">INTER_LINEAR</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">src_h</span><span class="o">&gt;=</span><span class="n">src_w</span><span class="p">:</span>
        <span class="n">img_boxs</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">merge_w</span>
        <span class="n">result_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">merge_img</span><span class="p">,</span><span class="n">img</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">img_boxs</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">merge_h</span>
        <span class="n">result_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">merge_img</span><span class="p">,</span><span class="n">img</span><span class="p">))</span>
    <span class="n">result_boxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">merge_bboxes</span><span class="p">,</span><span class="n">img_boxs</span><span class="p">])</span>
    <span class="n">pad_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">result_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">result_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pad_w</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">result_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">result_img</span><span class="p">,((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="n">pad_w</span><span class="p">,</span><span class="n">pad_w</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>
        <span class="n">result_boxes</span><span class="p">[:,[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">pad_w</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pad_h</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pad_w</span><span class="p">)</span>
        <span class="n">result_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">result_img</span><span class="p">,((</span><span class="n">pad_h</span><span class="p">,</span><span class="n">pad_h</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)))</span>
        <span class="n">result_boxes</span><span class="p">[:,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">pad_h</span>
    <span class="k">return</span> <span class="n">result_img</span><span class="p">,</span><span class="n">result_boxes</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">merge_img</span><span class="p">,</span> <span class="n">merge_bboxes</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">merge_image</span><span class="p">(</span><span class="n">img_new</span><span class="p">,</span> <span class="n">img_boxs</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">result_img</span><span class="p">,</span><span class="n">result_boxes</span> <span class="o">=</span> <span class="n">expand_rect</span><span class="p">(</span><span class="n">merge_img</span><span class="p">,</span><span class="n">merge_bboxes</span><span class="p">,</span><span class="n">img_new</span><span class="p">,</span><span class="n">img_boxs</span><span class="p">)</span>
</code></pre></div>
<h3 id="_5">图像增亮<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p><img alt="image-20210311134637017" src="../assets/image-20210311134637017.png" /></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">gain_light</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="n">h</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">lw</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">COLOR_RGB2GRAY</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span>
    <span class="n">lwaver</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.001</span> <span class="o">+</span> <span class="n">lw</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">h</span><span class="o">*</span><span class="n">w</span><span class="p">))</span>
    <span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lw</span> <span class="o">/</span> <span class="n">lwaver</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lw</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">lwaver</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">lw</span>
    <span class="n">gain</span><span class="p">[</span><span class="n">lw</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">cv2</span><span class="o">.</span><span class="n">convertScaleAbs</span><span class="p">(</span><span class="n">img</span> <span class="o">*</span> <span class="n">gain</span><span class="p">[:,:,</span><span class="kc">None</span><span class="p">])</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../onnx%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              ONNX简明教程
            </div>
          </div>
        </a>
      
      
        <a href="../pandas%E3%80%81matplotlib%E7%AE%80%E6%B4%81%E7%AC%94%E8%AE%B0/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              PD+PLT简洁笔记
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fb4a9340.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.ca5457b8.min.js"></script>
      
    
  </body>
</html>